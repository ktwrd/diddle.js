<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>extensionmanager.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ConfigurationManager.html">ConfigurationManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ConfigurationManager.html#get">get</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="DiddleEngine.html">DiddleEngine</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="DiscordWrapper.html">DiscordWrapper</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="DiscordWrapper.html#_ready">_ready</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="EngineExtensionManager.html">EngineExtensionManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EngineExtensionManager.html#append">append</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EngineExtensionManager.html#getByName">getByName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EngineExtensionManager.html#getByUID">getByUID</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="EngineScript.html">EngineScript</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="EventManager.html">EventManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EventManager.html#call">call</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EventManager.html#on">on</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ExtensionScript.html">ExtensionScript</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LocaleManager.html">LocaleManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="LocaleManager.html#get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="LocaleManager.html#switch">switch</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Logger.html">Logger</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Logger.html#debug">debug</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Logger.html#error">error</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Logger.html#info">info</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Logger.html#warn">warn</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PackageManager.html">PackageManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PackageManager.html#get">get</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ScriptManager.html">ScriptManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ScriptManager.html#_fetchScripts">_fetchScripts</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ScriptManager.html#_parseEventScript">_parseEventScript</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="StorageManager.html">StorageManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="StorageManager.html#get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="StorageManager.html#getByFilename">getByFilename</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="StorageManager.html#getByName">getByName</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="StorageObject.html">StorageObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="StorageObject.html#get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="StorageObject.html#resetID">resetID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="StorageObject.html#set">set</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="StorageObject.html#sync">sync</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">extensionmanager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const EngineScript = require("./enginescript.js");
const ExtensionScript = require("./extensionscript.js");
const path = require("path")
const fs = require("fs")

const manifest = {
	name: "org.js.diddle.engine.extension",
	version: "0.1"
}

function isClass(v) {
	return typeof v === 'function' &amp;&amp; /^\s*class\s+/.test(v.toString());
}

/**
 * @class
 * @property {string} cwd The absolute directory where all of the custom Engine Extensions live.
 * @extends {EngineScript}
 */
class EngineExtensionManager extends EngineScript {
	/**
	 * @param {DiddleEngine} diddle 
	 */
	constructor(diddle) {
		super(diddle,manifest);
		// Current Working Directory
		this.cwd = '';
	}

	_ready() {
		this._fetchExtensions();
	}

	_store = {
		/*
		&lt;ScriptUID>: ExtensionScript
		*/
	}

	/**
	 * @description Add Custom Engine Extension
	 * @param {ExtensionScript} extension 
	 */
	append(extension) {
		this._store[extension._ScriptUID] = extension;
	}

	/**
	 * @description Fetch Extension by its Unique Identifier
	 * @param {string} extension 
	 * @returns {ExtensionScript}
	 */
	getByUID(ScriptUID) {
		if (this._store[ScriptUID] == undefined) throw new Error(this.diddle.locale.get("ScriptExt.FetchFail.ExtensionNotFound"))
		return this._store[ScriptUID];
	}

	/**
	 * @description Returns an Array of all Extensions that match the given name.
	 * @param {*} ScriptName 
	 * @returns {ExtensionScript[]}
	 */
	getByName(ScriptName) {
		return Object.entries(this._store).filter(script => script[1].manifest.name == ScriptName);
	}

	_fetchExtensions() {
		var config = this.diddle.pacman.get("org.js.diddle.engine.config").get();

		var timestamp_start = Date.now();

		this.log.info(`fetching extensions...`);

		this.cwd = path.resolve(config.extensions);

		if (!fs.existsSync(this.cwd)) {
			try {
				fs.mkdirSync(this.cwd)
			} catch(e) {
				this.log.error(`cannot create extensions directory\n`,e);
				process.exit(1);
			}
			this.log.info(`created extensions directory`);
		}

		
		// Get Script Files
		var ext_filenames,ext_filtered = [];

		try {
			ext_filenames = fs.readdirSync(this.cwd).filter(f => f.endsWith(".js"));
		} catch(e) {
			this.log.error(`cannot fetch extensions directory\n`,e);
			process.exit(1);
		}

		for (let i = 0; i &lt; ext_filenames.length; i++) {
			let current_filename = ext_filenames[i];
			let current = require(path.join(this.cwd,current_filename));

			if (isClass(current)) {
				var ext = new current(this.diddle);
				if (ext.manifest.name)
				ext_filtered.push(ext);
				this.log.debug(`loaded extension ${ext.manifest.name}@${ext.manifest.version} (${ext._ScriptUID})`)
			} else {
				this.log.error(`extension '${path.join(this.cwd,current_filename)}' cannot be constructed (isn't a class)`);
				return;
			}
		}

		this.extensions = ext_filtered;

		this.log.info(`took ${Date.now() - timestamp_start}ms`);
	}
}
module.exports = EngineExtensionManager;</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Sun Oct 10 2021 01:15:43 GMT+0800 (Australian Western Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
